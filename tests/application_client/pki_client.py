"""PKI certificate management for CAL dynamic token testing."""

from enum import IntEnum
from ragger.backend.interface import BackendInterface, RAPDU
from ledgered.devices import DeviceType  # type: ignore[import-untyped]

class CertificatePubKeyUsage(IntEnum):
    """PKI certificate public key usage types."""

    CERTIFICATE_PUBLIC_KEY_USAGE_COIN_META = 0x08


# PKI certificates for onboarding the CAL mock key on Speculos
# These test certificates have TEST flags, they will be rejected on real devices
PKI_CERTIFICATES = {
    DeviceType.NANOSP: (
        "01010102010211040000000212010013020002140101160400000000200D44796E616D69635F546F6B656E"
        "3002000E310108320121332102E3C05B637A0626AB382004A9350BEB1DE47958A3B9FC1EFC6E16A721"
        "04C05FE73401013501031546304402207756CFA4C31D0732F45FE12AD824262C1359BD49A89EE847A5"
        "322D99023E1D2802204D6B36F57BE3DD3D0FF2BBD5ECC71FAAE5D52899742673200D9F8236A58913E3"
    ),
    DeviceType.NANOX: (
        "01010102010211040000000212010013020002140101160400000000200D44796E616D69635F546F6B656E"
        "3002000E310108320121332102E3C05B637A0626AB382004A9350BEB1DE47958A3B9FC1EFC6E16A721"
        "04C05FE734010135010215473045022100B483BB3A8D6B4EEF83DD75E7ADBFB4330F5C46BBCFAF343B"
        "6997B964C6DA1DCB022077F1F41F2C7931CF191364D0A4071E1DB8CE4FA510BC0E7E7517E7E973F4A1DA"
    ),
    DeviceType.STAX: (
        "01010102010211040000000212010013020002140101160400000000200D44796E616D69635F546F6B656E"
        "3002000E310108320121332102E3C05B637A0626AB382004A9350BEB1DE47958A3B9FC1EFC6E16A721"
        "04C05FE734010135010415463044022037C48A6217CE3EA24351B4DEB714A8420A64F985DF62E1820D"
        "421C6AC8AFF75F0220290A3296A4263346866F52520197C6FA2A5E6E32E464833D3598706EE9158DB0"
    ),
    DeviceType.FLEX: (
        "01010102010211040000000212010013020002140101160400000000200D44796E616D69635F546F6B656E"
        "3002000E310108320121332102E3C05B637A0626AB382004A9350BEB1DE47958A3B9FC1EFC6E16A721"
        "04C05FE734010135010515473045022100B31EF0A2398641FE938C55568DFC5F1A4297244C765A0C06"
        "59821361B812A4C6022023559941A0D58FEDA2B37008DDE3B1B27C85A4AEEAFF7D74BC68E093CEC4585E"
    ),
    DeviceType.APEX_P: (
        "01010102010211040000000212010013020002140101160400000000200D44796E616D69635F546F6B656E"
        "3002000E310108320121332102E3C05B637A0626AB382004A9350BEB1DE47958A3B9FC1EFC6E16A721"
        "04C05FE73401013501061547304502210082871ACD246B31207A6D526628D0F4EB702F5DF60A906502"
        "AC94E8D5FF2C7A89022016C84B407E53113F26916C574C0B6DC4FC129C401E44FEBCB64C01C1BACC9E82"
    ),
}


class PKIClient:
    """PKI certificate client for CAL dynamic token validation."""

    _CLA: int = 0xB0
    _INS: int = 0x06

    def __init__(self, client: BackendInterface) -> None:
        self._client = client

    def send_certificate(
        self, key_usage: CertificatePubKeyUsage, payload: bytes
    ) -> RAPDU:
        """Send PKI certificate to device."""
        return self.send_raw(key_usage, payload)

    def send_raw(self, key_usage: CertificatePubKeyUsage, payload: bytes) -> RAPDU:
        """Send raw PKI certificate APDU."""
        header = bytearray()
        header.append(self._CLA)
        header.append(self._INS)
        header.append(key_usage)
        header.append(0x00)
        header.append(len(payload))
        return self._client.exchange_raw(header + payload)
